# version: '3.8'
# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
name: docker_publish-stack

services:
  app:
    image: ghcr.io/${GITHUB_USER}/docker_publish:${IMAGE_TAG}
    pull_policy: always
    # –ò–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    container_name: docker-publish-test
    # –ü–æ—Ä—Ç—ã: —Ö–æ—Å—Ç:–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    ports:
      - "${HOST_PORT:-3000}:3000"
    # –°–µ—Ç—å
    networks:
      # - app-network
      - monitoring
    # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    environment:
      - RUNTIME_SECRET=${RUNTIME_SECRET}
      - NODE_ENV=${NODE_ENV:-production}
      - IMG_VERSION=${IMAGE_TAG}
      - APP_CONFIG_PATH=/app/config/config.json
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã
    secrets:
      - source: runtime_secret
        target: /run/secrets/runtime_secret_2
    # –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ñ–∏–≥–∏
    configs:
      - source: app_config
        target: /app/config/config.json
        mode: 444  # –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
    # Healthcheck
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s  # –î–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –≤—Ä–µ–º—è –Ω–∞ —Å—Ç–∞—Ä—Ç
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
    restart: unless-stopped
    # –õ–µ–π–±–ª—ã (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
    # labels:
    #   - "org.opencontainers.image.source=https://github.com/${GITHUB_USER}/docker_publish"
    #   - "org.opencontainers.image.version=${IMAGE_TAG}"

  # === Prometheus ===
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    networks:
      - monitoring
    volumes:
      - ./prometheus:/etc/prometheus
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    restart: unless-stopped

  # === Grafana ===
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3000"
    networks:
      - monitoring
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_FEATURE_TOGGLES_ENABLE=ngalert
    restart: unless-stopped

  # === Alertmanager ===
  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    networks:
      - monitoring
    volumes:
      - ./alertmanager/alertmanager.tmpl.yml:/etc/alertmanager/alertmanager.tmpl.yml:ro
      - ./alertmanager/prepare-config.sh:/etc/alertmanager/prepare-config.sh:rw
    environment:
      - ALERTMANAGER_TELEGRAM_TOKEN=${ALERTMANAGER_TELEGRAM_TOKEN}
      - ALERTMANAGER_CHAT_ID=${ALERTMANAGER_CHAT_ID}
    # üî• –°–±—Ä–∞—Å—ã–≤–∞–µ–º ENTRYPOINT –∏ –∑–∞–ø—É—Å–∫–∞–µ–º shell
    entrypoint: ["/bin/sh"]
          # chmod +x /etc/alertmanager/prepare-config.sh &&
    command: >
      -c '
      echo "üîß –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Alertmanager..." &&
      exec /etc/alertmanager/prepare-config.sh
      '
    restart: unless-stopped
    container_name: alertmanager

volumes:
  prometheus_data:
  grafana_data:

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ—Ç–∏
networks:
  monitoring:
    driver: bridge

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥–∏
configs:
  app_config:
    file: ./config/app-config.json

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–µ–∫—Ä–µ—Ç—ã
secrets:
  runtime_secret:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–π–ª, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    file: ./secrets/runtime-secret.txt
    # –ï—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Äî Docker –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π —Å–µ–∫—Ä–µ—Ç (–Ω–æ –ª—É—á—à–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å)
    # –í–∞–∂–Ω–æ: —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

  # –ü—Ä–∏–º–µ—Ä: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å TLS-—Å–µ–∫—Ä–µ—Ç—ã –ø–æ–∑–∂–µ
  # tls_key:
  #   file: ./secrets/tls.key
